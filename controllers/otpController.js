const { validationResult } = require("express-validator");
const bcrypt = require("bcrypt");
const OtpCode = require("../models/otpCode");
const User = require("../models/User");
const AuthCredential = require("../models/AuthCredential"); // Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù…Ù‡
const EmailUtils = require("../utils/emailUtils.js");

const OTP_EXPIRY = parseInt(process.env.OTP_EXPIRY) || 300; // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: 5 Ø¯Ù‚Ø§Ø¦Ù‚

// âœ… Ø·Ù„Ø¨ Ø¥Ø±Ø³Ø§Ù„ OTP
exports.requestOTP = async (req, res) => {
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    return res.status(400).json({ errors: errors.array() });
  }

  const { email } = req.body;
  try {
    const user = await User.findOne({ email });
    if (!user) {
      return res.status(404).json({ message: "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" });
    }

    const otp = OtpCode.generateOTP();
    const expiresAt = new Date(Date.now() + OTP_EXPIRY * 1000);

    await OtpCode.create({ userId: user._id, otp, expiresAt });
    await EmailUtils.sendEmail(user.email, "Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚", `Ø±Ù…Ø² OTP Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ùˆ: ${otp}`);

    res.status(200).json({ message: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ OTP Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" });
  } catch (error) {
    res.status(500).json({ message: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ OTP", error: error.message });
  }
};

// âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© OTP
exports.verifyOTP = async (req, res) => {
  const { email, otp } = req.body;
  try {
    const user = await User.findOne({ email });
    if (!user) return res.status(404).json({ message: "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" });

    const validEntry = await OtpCode.findValidOTP(user._id, otp);
    if (!validEntry) return res.status(400).json({ message: "OTP ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©" });

    res.status(200).json({ message: "OTP ØµØ­ÙŠØ­" });
  } catch (error) {
    res.status(500).json({ message: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† OTP", error: error.message });
  }
};

// âœ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
exports.resetPassword = async (req, res) => {
  const { email, otp, newPassword } = req.body;
  try {
    // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
    if (!newPassword || newPassword.length < 6) {
      return res.status(400).json({ message: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 6 Ø£Ø­Ø±Ù" });
    }
    if (!/(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[\W_]).{6,}/.test(newPassword)) {
      return res.status(400).json({ message: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ø±Ù ÙƒØ¨ÙŠØ± ÙˆØ­Ø±Ù ØµØºÙŠØ± ÙˆØ±Ù‚Ù… ÙˆØ±Ù…Ø² Ø®Ø§Øµ" });
    }

    const user = await User.findOne({ email });
    if (!user) return res.status(404).json({ message: "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" });

    const validEntry = await OtpCode.findValidOTP(user._id, otp);
    if (!validEntry) return res.status(400).json({ message: "OTP ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©" });

    // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    const auth = await AuthCredential.findOne({ userId: user._id }).select("password");
    if (auth && (await bcrypt.compare(newPassword, auth.password))) {
      return res.status(400).json({ message: "Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©" });
    }

    // ðŸ”¹ **ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸**
    const hashedPassword = await bcrypt.hash(newPassword, 12);

    // ðŸ”¹ **ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ AuthCredential**
    await AuthCredential.findOneAndUpdate(
      { userId: user._id },
      { password: hashedPassword },
      { new: true }
    );

    // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø±Ù…ÙˆØ² OTP Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    await OtpCode.deleteMany({ userId: user._id });

    res.status(200).json({ message: "ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­" });
  } catch (error) {
    res.status(500).json({ message: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", error: error.message });
  }
};
